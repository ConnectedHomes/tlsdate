From 44b3f0249b342950f54e869bbfad67fbc132cff2 Mon Sep 17 00:00:00 2001
From: Chris Morin <cmtm@google.com>
Date: Tue, 20 Nov 2018 17:00:45 -0800
Subject: [PATCH 25/26] Adjust clock gradually when possible

Use adjtime instead of settimeofday when device time is within 30
seconds of the real time. The clock jumping backwards can make certain
logs difficult to understand, and adjtime preserves clock monotonicity.

BUG=chromium:907304
TEST=ensure clock doesn't move backwards after boot

Change-Id: I4efd081c456cecd228037aa9f8d0b927baaf2029
Reviewed-on: https://chromium-review.googlesource.com/1344802
Commit-Ready: Christopher Morin <cmtm@google.com>
Tested-by: Christopher Morin <cmtm@google.com>
Reviewed-by: Dan Erat <derat@chromium.org>
---
 src/events/time_set.c |  5 ++++-
 src/seccomp.c         |  2 ++
 src/tlsdate-setter.c  | 21 ++++++++++++++++++++-
 src/tlsdate.h         |  2 ++
 4 files changed, 28 insertions(+), 2 deletions(-)

Index: tlsdate/src/events/time_set.c
===================================================================
--- tlsdate.orig/src/events/time_set.c
+++ tlsdate/src/events/time_set.c
@@ -62,7 +62,7 @@ handle_time_setter (struct state *state,
       error ("[event:%s] time setter exited gracefully", __func__);
       break;
     case SETTER_SET_ERR:
-      error ("[event:%s] time setter could not settimeofday()", __func__);
+      error ("[event:%s] time setter could not set time", __func__);
       break;
     case SETTER_NO_RTC:
       error ("[event:%s] time setter could sync rtc", __func__);
@@ -73,6 +73,9 @@ handle_time_setter (struct state *state,
     case SETTER_READ_ERR:
       error ("[event:%s] time setter could not read time", __func__);
       break;
+    case SETTER_GETTIME_ERR:
+      error ("[event:%s] time setter could not gettimeofday()", __func__);
+      break;
     default:
       error ("[event:%s] received bogus status from time setter: %d",
              __func__, status);
Index: tlsdate/src/seccomp.c
===================================================================
--- tlsdate.orig/src/seccomp.c
+++ tlsdate/src/seccomp.c
@@ -90,6 +90,8 @@ enable_setter_seccomp (void)
     SC_ALLOW (write),
     SC_ALLOW (pwritev),
 
+    SC_ALLOW (adjtimex),
+    SC_ALLOW (gettimeofday),
     SC_ALLOW (settimeofday),
     SC_ALLOW (ioctl), /* TODO(wad) filter for fd and RTC_SET_TIME */
 #ifdef __NR_time /* This is required for x86 systems */
Index: tlsdate/src/tlsdate-setter.c
===================================================================
--- tlsdate.orig/src/tlsdate-setter.c
+++ tlsdate/src/tlsdate-setter.c
@@ -147,7 +147,26 @@ time_setter_coprocess (int time_fd, int 
           status = SETTER_BAD_TIME;
           if (!state->opts.dry_run)
             {
-              if (settimeofday (&tv, NULL) < 0)
+              struct timeval our_time = { 0, 0 };
+              if (gettimeofday (&our_time, NULL) < 0)
+                {
+                  status = SETTER_GETTIME_ERR;
+                  goto notify_and_die;
+                }
+              struct timeval delta = {tv.tv_sec - our_time.tv_sec, 0};
+
+              /* Adjust clock gradually if it's close enough to the right time.
+               */
+              if (-ADJTIME_THRESHOLD < delta.tv_sec &&
+                  delta.tv_sec < ADJTIME_THRESHOLD)
+                {
+                  if (adjtime (&delta, NULL) < 0)
+                    {
+                      status = SETTER_SET_ERR;
+                      goto notify_and_die;
+                    }
+                }
+              else if (settimeofday (&tv, NULL) < 0)
                 {
                   status = SETTER_SET_ERR;
                   goto notify_and_die;
Index: tlsdate/src/tlsdate.h
===================================================================
--- tlsdate.orig/src/tlsdate.h
+++ tlsdate/src/tlsdate.h
@@ -42,6 +42,7 @@
 #define SUBPROCESS_TRIES 10
 #define SUBPROCESS_WAIT_BETWEEN_TRIES 10
 #define RESOLVER_TIMEOUT 30
+#define ADJTIME_THRESHOLD 30
 /* Invalidate the network sync once per day. */
 #define STEADY_STATE_INTERVAL (60*60*24)
 /* Check if the clock has jumped every four hours. */
@@ -80,6 +81,7 @@
 #define SETTER_SET_ERR 5
 #define SETTER_NO_SBOX 6
 #define SETTER_NO_RTC 7
+#define SETTER_GETTIME_ERR 8
 
 #define TEST_HOST 'w', 'w', 'w', '.', 'g', 'o', 'o', 'g', 'l', 'e', '.', \
                   'c', 'o', 'm'
