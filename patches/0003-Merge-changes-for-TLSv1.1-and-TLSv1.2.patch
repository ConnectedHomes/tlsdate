From fe8b4602750c0e229aba15ce76259784c8674991 Mon Sep 17 00:00:00 2001
From: James Denness <jd@masabi.com>
Date: Thu, 20 Jul 2017 10:02:18 +0100
Subject: [PATCH] enable TLSv1.1 and TLSv1.2

---
 src/tlsdate-helper.c | 10 ++++++++++
 src/tlsdate.c        |  2 +-
 src/tlsdate.h        |  2 +-
 3 files changed, 12 insertions(+), 2 deletions(-)

Index: tlsdate/src/tlsdate-helper.c
===================================================================
--- tlsdate.orig/src/tlsdate-helper.c
+++ tlsdate/src/tlsdate-helper.c
@@ -1141,6 +1141,14 @@ run_ssl (uint32_t *time_map, int time_is
   {
     verb ("V: using TLSv1_client_method()");
     ctx = SSL_CTX_new(TLSv1_client_method());
+  } else if (0 == strcmp("tlsv11", protocol))
+  {
+    verb ("V: using TLSv1_1_client_method()");
+    ctx = SSL_CTX_new(TLSv1_1_client_method());
+  } else if (0 == strcmp("tlsv12", protocol))
+  {
+    verb ("V: using TLSv1_2_client_method()");
+    ctx = SSL_CTX_new(TLSv1_2_client_method());
   } else
     die("Unsupported protocol `%s'", protocol);
 
Index: tlsdate/src/tlsdate.c
===================================================================
--- tlsdate.orig/src/tlsdate.c
+++ tlsdate/src/tlsdate.c
@@ -88,7 +88,7 @@ usage (void)
            " [-n|--dont-set-clock]\n"
            " [-H|--host] [hostname|ip]\n"
            " [-p|--port] [port number]\n"
-           " [-P|--protocol] [sslv23|sslv3|tlsv1]\n"
+           " [-P|--protocol] [sslv23|sslv3|tlsv1|tlsv11|tlsv12]\n"
            " [-C|--certcontainer] [dirname|filename]\n"
            " [-v|--verbose]\n"
            " [-V|--showtime] [human|raw]\n"
Index: tlsdate/src/tlsdate.h
===================================================================
--- tlsdate.orig/src/tlsdate.h
+++ tlsdate/src/tlsdate.h
@@ -27,7 +27,7 @@
 #define DEFAULT_HOST "google.com"
 #define DEFAULT_PORT "443"
 #define DEFAULT_PROXY "none"
-#define DEFAULT_PROTOCOL "tlsv1"
+#define DEFAULT_PROTOCOL "tlsv12"
 #define DEFAULT_CERTDIR "/etc/ssl/certs"
 #define DEFAULT_CERTFILE TLSDATE_CERTFILE
 #define DEFAULT_DAEMON_CACHEDIR "/var/cache/tlsdated"
Index: tlsdate/src/tlsdate-helper-plan9.c
===================================================================
--- tlsdate.orig/src/tlsdate-helper-plan9.c
+++ tlsdate/src/tlsdate-helper-plan9.c
@@ -986,6 +986,14 @@ run_ssl (uint32_t *time_map, int time_is
   {
     verb ("V: using TLSv1_client_method()\n");
     ctx = SSL_CTX_new(TLSv1_client_method());
+  } else if (0 == strcmp("tlsv11", protocol))
+  {
+    verb ("V: using TLSv1_1_client_method()");
+    ctx = SSL_CTX_new(TLSv1_1_client_method());
+  } else if (0 == strcmp("tlsv12", protocol))
+  {
+    verb ("V: using TLSv1_2_client_method()");
+    ctx = SSL_CTX_new(TLSv1_2_client_method());
   } else
     die("Unsupported protocol `%s'\n", protocol);
 
